//
//  pw_tc_utils.cpp
//  pw_tc_converter_v3
//
//  Created by Gongxian Liu on 5/23/19.
//  Copyright Â© 2019 Gongxian Liu. All rights reserved.
//

#include <stdio.h>
#include <math.h>
#include "pw_tc_utils.h"

static struct tc_PWLumaCoefficients pw_luma_coefficients[PW_CS_NB] = {
    [PW_CS_BT601]  = {0.2990,  0.5870,  0.1140},
    [PW_CS_BT709]  = {0.2126,  0.7152,  0.0722},
    [PW_CS_DCI_P3] = {0.22897, 0.69174, 0.07929},
    [PW_CS_BT2020] = {0.2627,  0.6780,  0.0593},
    [PW_CS_UNSPECIFIED] = {0.2627, 0.678, 0.0593},
};

//from https://en.wikipedia.org/wiki/DCI-P3#cite_note-PointersGamut-24
static struct tc_PW_WhitepointCoefficients pw_whitepoint_coefficients[WP_NB] = {
    [WP_D65]        = { 0.3127, 0.3290 },
    [WP_DCI]        = { 0.314,  0.351}, // Theater
    [WP_D60]        = { 0.32168, 0.33767}, // ACES Cinema
    [WP_User]       = { 0.3127, 0.3290},
    //    [WP_NB]   = { 0.3100, 0.3160 },
};
static struct tc_PWColorPrimaries_coeffs pw_color_primaries[PW_PRM_NB+1] = {
    [PW_PRM_BT601]              = {  0.640, 0.330, 0.290, 0.600, 0.150, 0.060  },
    [PW_PRM_BT709]              = {  0.640, 0.330, 0.300, 0.600, 0.150, 0.060  },
    [PW_PRM_DCI_P3]             = {  0.680, 0.320, 0.265, 0.690, 0.150, 0.060  },
    [PW_PRM_BT2020]             = {  0.708, 0.292, 0.170, 0.797, 0.131, 0.046  },
    [PW_PRM_ARRI_WG]            = {  0.684, 0.313, 0.211, 0.848, 0.0861, -0.102},
    [PW_PRM_ACES_AP0]           = {  0.7347, 0.2653, 0.0, 1.0, 0.0001, -0.0770 },
    [PW_PRM_ACES_AP1]           = {  0.713, 0.293, 0.165, 0.83, 0.128, 0.0440  },
    [PW_PRM_CINITY]             = {  0.705, 0.2872,0.1205,0.8029,0.1557,0.0288 },
    [PW_PRM_GAMUT3]             = {  0.730, 0.280, 0.140, 0.855, 0.100, -0.050 },
    [PW_PRM_GAMUT3_CINE]        = {  0.766, 0.275, 0.225, 0.800, 0.089, -0.087 },
    [PW_PRM_UNSPECIFIED]        = {  0.708, 0.292, 0.170, 0.797, 0.131, 0.046  },// if unspecified, use BT2020 as Default
};


double tc_PQ_EOTF(double in)
{
    double fo;
    double nT;
    double m1=(double)2610/4096/4;
    double m2=(double)128*2523/4096;
    double c1=(double)3424/4096;
    double c2=(double)32*2413/4096;
    double c3=(double)32*2392/4096;
    
    nT = pow(in,1/m2);
    fo = pow(fmax(0,(nT-c1))/(c2-c3*nT), 1/m1);
    
    return fo;


}

double tc_PQ_OETF(double in)
{
    double fo;
    double nT;
    double m1=(double)2610/4096/4;
    double m2=(double)128*2523/4096;
    double c1=(double)3424/4096;
    double c2=(double)32*2413/4096;
    double c3=(double)32*2392/4096;
    
    if (in!=0)
    {
        nT = pow(in,m1);
        fo = pow((c1+c2*nT)/(1+c3*nT), m2);
    }
    else
        fo = 0;
    return fo;
}


double tc_HLG_OETF(double in_data)
{
    double out_data = 0;
    double a = 0.17883277;
    double b = 1 - 4 * a;
    //    double ln4a = log(4*a);
    double c = 0.55991073;
    
    if (in_data >=0 && in_data <= 1.0/12) {
        out_data = sqrt(3 * in_data);
    }else
    {
        out_data = a * log(12 * in_data - b) + c;
    }
    
    return out_data;
}

double tc_HLG_EOTF(double E)
{
    double out_d;
    double a = 0.17883277;
    double b = 1 - 4 * a;
    //    double ln4a = log(4*a);
    double c = 0.55991073;
    
    if (E >=0 && E<=0.5) {
        out_d = E * E / 3;
    }else
    {
        out_d = (exp((E - c)/a) + b)/12.0;
    }
    
    return out_d;
}

// Need check this curve more
double tc_ACES_cc_OETF(double E)
{
    double out = 0;
    double ll = 0.000030517578125;
    double ll2 = ll / 2;
    if (E <=0 ) {
        out = -0.358447;
    }else if(E < ll)
    {
        out = 0.554759 + 0.0570776 * log2(ll2 + E / 2);
    }else
        out = 0.554795 + 0.0570776 * log2(E);
    
    return out;
}

double tc_ACES_cc_EOTF(double E)
{
    double out = 0;
    double ll = 0.000030517578125;
//    double ll2 = ll / 2;
//    
//    double a = 0.554759;
//    double b = 0.0570776;
    if (E <= -0.30137 ) {
        out = pow(2, 17.52*E - 9.72) - ll;
    }else if(E < 1.468)
    {
        out = pow(2, 17.52*E - 9.72);
    }else
        out = 65504;
    
    return out;
}

double tc_ACES_cct_OETF(double E)
{
    double out = 0;
    
    if (E <= 0.0078125) {
        out = 0.0729055341958355 + 10.5402377416545 * E;
    }
        out = 0.554795  + 0.0570776 * log2(E);
    
    return  out;
}


// linear to sLog3
double tc_sLog3_OETF(double in)
{
    
    double out = 0;
    if (in < 0.01125000) {
        out = (in * ( 171.2102946929 - 95.0) /0.01125000 + 95.0) / 1023.0;
    }else
    {
        out = (420.0 + log10((in+0.01)/(0.18+0.01)) * 261.5)/1023.0;
    }
    return out;
}


//sLog3 to linear
double tc_sLog3_EOTF(double in)
{
    double toe1 = 171.2102946929 / 1023.0;
    double exp_ = 0.18 + 0.01;
    double out = 0;
    if (in >= toe1) {
        out = pow(10, (in * 1023 - 420.0)/261.5) * 0.19 - 0.01;
    } else
    {
        out = ( in * 1023.0 - 95.0) * 0.01125000 / ( 171.2102946929 - 95.0);
    }
    return out;
}



double tc_ACES_cct_EOTF(double E)
{
    double out = 0;
    double a = 0.0729055341958355;
    double b = 10.5402377416545;
    double c = 0.554795;
    double d = 0.0570776;
    
    
    
    if (E <= 0.155251141552511) {
        out = (E - a) / b;//
    }else
        out = pow(2,(E-c)/d);
    return  out;

}

double tc_BT2020_10_EOTF(double E)
{
    double out = 0;
    double alhpa = 1.0993;
    //    double beta = 0.0181;
    
    if (E>=0 && E <0.08145/*4.5 * beta*/) {
        out = E/4.5;
    }else
    {
        double t = (E + alhpa - 1)/alhpa;
        out = pow(t,1/0.45);
    }
    return out;
}

double tc_BT2020_10_OETF(double O)
{
    double out;
    double alhpa = 1.0993;
    double beta = 0.0181;
    
    if (O>=0 && O < beta) {
        out = 4.5 * O;
    }else
    {
        out = alhpa * pow(O, 0.45) - alhpa - 1;
    }
    
    return out;
}

double tc_CINITY_OEFT(double E)
{
    double out = E;
    double aa = 9.980283854357202;
    double bb = 10.244520005400748;
    out = (log2(E+0.001) + aa) / bb;
    
    return out;
}
double tc_CINITY_EOFT(double O)
{
    double out = O;
    
    double aa = 9.980283854357202;
    double bb = 10.244520005400748;
    
    out = pow(2,(bb * O - aa)) - 0.001;
    
    return out;
}



//double tc_Log_EOTF(double E)
//{
//    double out;
//    out = log2(E);
//    return out;
//}
//double tc_Log_OETF(double O){
//    double out;
//    
//    return  out;
//}

void tc_pw_invert_matrix3x3(const double in[3][3], double out[3][3])
{
    double m00 = in[0][0], m01 = in[0][1], m02 = in[0][2],
    m10 = in[1][0], m11 = in[1][1], m12 = in[1][2],
    m20 = in[2][0], m21 = in[2][1], m22 = in[2][2];
    int i, j;
    double det;
    
    out[0][0] =  (m11 * m22 - m21 * m12);
    out[0][1] = -(m01 * m22 - m21 * m02);
    out[0][2] =  (m01 * m12 - m11 * m02);
    out[1][0] = -(m10 * m22 - m20 * m12);
    out[1][1] =  (m00 * m22 - m20 * m02);
    out[1][2] = -(m00 * m12 - m10 * m02);
    out[2][0] =  (m10 * m21 - m20 * m11);
    out[2][1] = -(m00 * m21 - m20 * m01);
    out[2][2] =  (m00 * m11 - m10 * m01);
    
    det = m00 * out[0][0] + m10 * out[0][1] + m20 * out[0][2];
    det = 1.0 / det;
    
    for (i = 0; i < 3; i++) {
        for (j = 0; j < 3; j++)
        out[i][j] *= det;
    }
}

struct tc_PWColorPrimaries_coeffs *tc_pw_get_prm_coefficients(enum tc_PWColorPrimaries prm)
{
    return  &pw_color_primaries[prm];
}
struct tc_PW_WhitepointCoefficients *tc_pw_get_wp_coefs(enum tc_Whitepoint wp)
{
    return &pw_whitepoint_coefficients[wp];
}

struct tc_PWLumaCoefficients *tc_pw_get_luma_coefs(enum tc_PWColorMatrix csp) {

    return &pw_luma_coefficients[csp];

}

void tc_pw_ColorTemperatureToXY(double clr_temp,double *xx,double *yy)
{
    double x,y;
    
    double cct = clr_temp;
    
    if (cct > 7000 && cct < 25000) {
        x = -2.0064* (pow(10, 9)/pow(cct, 3)) +  1.9018* (pow(10, 6) / pow(cct, 2)) + 0.24748*(1000.0 /cct) + 0.237040;
    }else if(cct<=7000)
    {
        x = -4.607*(pow(10, 9)/pow(cct, 3)) + 2.9678*(pow(10, 6) / pow(cct, 2)) + 0.09911 * (1000.0 /cct) + 0.244063;
    }else
        x = 0.3127;
    
    y = -3 * x * x + 2.87 * x - 0.275;
    
    *xx = x;
    *yy = y;
}

void tc_pw_fill_rgb2yuv_table(const struct tc_PWLumaCoefficients *coeffs,
                                  double rgb2yuv[3][3])
{
    double bscale, rscale;
    rgb2yuv[0][0] = coeffs->cr;
    rgb2yuv[0][1] = coeffs->cg;
    rgb2yuv[0][2] = coeffs->cb;
    bscale = 0.5 / (coeffs->cb - 1.0);
    rscale = 0.5 / (coeffs->cr - 1.0);
    rgb2yuv[1][0] = bscale * coeffs->cr;
    rgb2yuv[1][1] = bscale * coeffs->cg;
    rgb2yuv[1][2] = 0.5;
    rgb2yuv[2][0] = 0.5;
    rgb2yuv[2][1] = rscale * coeffs->cg;
    rgb2yuv[2][2] = rscale * coeffs->cb;
}

void tc_pw_mul3x3(double dst[3][3], const double src1[3][3], const double src2[3][3])
{
    int m, n;
    
    for (m = 0; m < 3; m++)
    for (n = 0; n < 3; n++)
    dst[m][n] = src2[m][0] * src1[0][n] +
                src2[m][1] * src1[1][n] +
                src2[m][2] * src1[2][n] ;
}

void tc_pw_fill_rgb2xyz_table(const struct tc_PWColorPrimaries_coeffs *coeffs,double rgb2xyz[3][3],tc_PW_WhitepointCoefficients *wp)
{
    double i[3][3], sr, sg, sb, zw;
    
    rgb2xyz[0][0] = coeffs->xr / coeffs->yr;
    rgb2xyz[0][1] = coeffs->xg / coeffs->yg;
    rgb2xyz[0][2] = coeffs->xb / coeffs->yb;
    rgb2xyz[1][0] = rgb2xyz[1][1] = rgb2xyz[1][2] = 1.0;
    rgb2xyz[2][0] = (1.0 - coeffs->xr - coeffs->yr) / coeffs->yr;
    rgb2xyz[2][1] = (1.0 - coeffs->xg - coeffs->yg) / coeffs->yg;
    rgb2xyz[2][2] = (1.0 - coeffs->xb - coeffs->yb) / coeffs->yb;
    tc_pw_invert_matrix3x3(rgb2xyz, i);
    zw = 1.0 - wp->xw - wp->yw;
    sr = i[0][0] * wp->xw + i[0][1] * wp->yw + i[0][2] * zw;
    sg = i[1][0] * wp->xw + i[1][1] * wp->yw + i[1][2] * zw;
    sb = i[2][0] * wp->xw + i[2][1] * wp->yw + i[2][2] * zw;
    rgb2xyz[0][0] *= sr;
    rgb2xyz[0][1] *= sg;
    rgb2xyz[0][2] *= sb;
    rgb2xyz[1][0] *= sr;
    rgb2xyz[1][1] *= sg;
    rgb2xyz[1][2] *= sb;
    rgb2xyz[2][0] *= sr;
    rgb2xyz[2][1] *= sg;
    rgb2xyz[2][2] *= sb;
}

struct tc_PWColorPrimaries_coeffs *tc_pw_get_color_primaries(enum tc_PWColorPrimaries prm)
{
    struct tc_PWColorPrimaries_coeffs *coeffs;
    
    if (prm >= PW_PRM_NB)
    return NULL;
    coeffs = &pw_color_primaries[prm];
    
    //    printf("color primaries are :\n");
    //    printf("%f %f %f %f %f %f \n",coeffs->xb,coeffs->xg,coeffs->xr,coeffs->yb,coeffs->yg,coeffs->yr);
    if (!coeffs->xr)
        return NULL;
    
    return coeffs;
}


///////
//AI module
void tc_MBF(double *MBF_data, int *input, int input_num, int *input_MBF_num, double *MBF)
{
    int i=0;
    int j=0;
    for (j=0; j<input_num; j++)
        for (i =0; i< input_MBF_num[j]; i++){
            
            double f1=(MBF_data[(j+i)*4+1]-MBF_data[(j+i)*4]);
            if (f1==0)
                f1=1;
            else
                f1=(input[j]-MBF_data[(j+i)*4])/f1;
            
            double f2=(MBF_data[(j+i)*4+3]-MBF_data[(j+i)*4+2]);
            if (f2==0)
                f2=1;
            else
                f2=1-(input[j]-MBF_data[i*4+2])/f2;
            
            MBF[j+i] = fmax(0,fmin(1,fmin(f1,f2)));
        }
}
void iris_MBF(int *MBF_data, int *input, int input_num, int *input_MBF_num, int *MBF)
{
    int i=0;
    int j=0;
    int MBF_max=1023;
    for (j=0; j<input_num; j++)
        for (i =0; i< input_MBF_num[j]; i++){
            
            int f1=(MBF_data[(j+i)*4+1]-MBF_data[(j+i)*4]);
            if (f1==0)
                f1=MBF_max;
            else
                f1=MBF_max*(input[j]-MBF_data[(j+i)*4])/f1;
            
            int f2=(MBF_data[(j+i)*4+3]-MBF_data[(j+i)*4+2]);
            if (f2==0)
                f2=MBF_max;
            else
                f2=MBF_max-MBF_max*(input[j]-MBF_data[i*4+2])/f2;
            
            MBF[j+i] = pw_max(0,pw_min(MBF_max,pw_min(f1,f2)));
        }
}
void tc_Rule_Evaluation(double *in_MBF, int in_num, int r_num, int *rules, double *out_MBF)
{
    int output_MBF_index[20]={0};
    int i=0, j=0;
    for (i=0; i<r_num; i++)
    {
        double MBF=1;
        
        for(j=0; j<in_num; j++)
        {
            int a=rules[i*(in_num+1)+j];
            if (a>=0)
                MBF=fmin(in_MBF[j*in_num+a], MBF);
        }
        
        int b=rules[i*(in_num+1)+in_num];
        if (output_MBF_index[b]==0){
            output_MBF_index[b]=1;
            out_MBF[b]=MBF;
        }else{
            output_MBF_index[b]+=1;
            out_MBF[b]=fmax(MBF,out_MBF[b]);
        }
    }
}

void iris_Rule_Evaluation(int *in_MBF, int in_num, int r_num, int *rules, int *out_MBF)
{
    int output_MBF_index[20]={0};
    int i=0, j=0;
    for (i=0; i<r_num; i++)
    {
        int MBF=1023;
        
        for(j=0; j<in_num; j++)
        {
            int a=rules[i*(in_num+1)+j];
            if (a>=0)
                MBF=pw_min(in_MBF[j*in_num+a], MBF);
        }
        
        int b=rules[i*(in_num+1)+in_num];
        if (output_MBF_index[b]==0){
            output_MBF_index[b]=1;
            out_MBF[b]=MBF;
        }else{
            output_MBF_index[b]+=1;
            out_MBF[b]=pw_max(MBF,out_MBF[b]);
        }
    }
}
void tc_Defuzzification(double *out_MBF, double *out_MBF_data, int output_num, int *out_MBF_num, int *output)
{
    
    int i=0,j=0;
    
    for (j=0; j<output_num; j++)
    {
        double sum=0;
        double out=0;
        for (i=0; i<out_MBF_num[j]; i++)
        {
            out+=out_MBF_data[j*out_MBF_num[j]+i]*out_MBF[i];
            sum+=out_MBF[i];
        }
        if (sum==0)
            output[j]=0;
        else
            output[j] = out/sum;
    }
}

void iris_Defuzzification(int *out_MBF, int *out_MBF_data, int output_num, int *out_MBF_num, int *output)
{
    
    int i=0,j=0;
    
    for (j=0; j<output_num; j++)
    {
        long sum=0;
        int out=0;
        for (i=0; i<out_MBF_num[j]; i++)
        {
            out+=out_MBF_data[j*out_MBF_num[j]+i]*out_MBF[i];
            sum+=out_MBF[i];
        }
        if (sum==0)
            output[j]=0;
        else
            output[j] = out/sum;
    }
}
///////

// conversion between half and float

static uint16_t basetable[512]={0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x2, 0x4, 0x8, 0x10, 0x20, 0x40, 0x80, 0x100, 0x200, 0x400, 0x800, 0xc00, 0x1000, 0x1400, 0x1800, 0x1c00, 0x2000, 0x2400, 0x2800, 0x2c00, 0x3000, 0x3400, 0x3800, 0x3c00, 0x4000, 0x4400, 0x4800, 0x4c00, 0x5000, 0x5400, 0x5800, 0x5c00, 0x6000, 0x6400, 0x6800, 0x6c00, 0x7000, 0x7400, 0x7800, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x7c00, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8001, 0x8002, 0x8004, 0x8008, 0x8010, 0x8020, 0x8040, 0x8080, 0x8100, 0x8200, 0x8400, 0x8800, 0x8c00, 0x9000, 0x9400, 0x9800, 0x9c00, 0xa000, 0xa400, 0xa800, 0xac00, 0xb000, 0xb400, 0xb800, 0xbc00, 0xc000, 0xc400, 0xc800, 0xcc00, 0xd000, 0xd400, 0xd800, 0xdc00, 0xe000, 0xe400, 0xe800, 0xec00, 0xf000, 0xf400, 0xf800, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00, 0xfc00};

static uint8_t shifttable[512]={0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x17, 0x16, 0x15, 0x14, 0x13, 0x12, 0x11, 0x10, 0xf, 0xe, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xd, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x17, 0x16, 0x15, 0x14, 0x13, 0x12, 0x11, 0x10, 0xf, 0xe, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0xd, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xd};


static unsigned int mantissatable[2048]={0x0, 0x33800000, 0x34000000, 0x34400000, 0x34800000, 0x34a00000, 0x34c00000, 0x34e00000, 0x35000000, 0x35100000, 0x35200000, 0x35300000, 0x35400000, 0x35500000, 0x35600000, 0x35700000, 0x35800000, 0x35880000, 0x35900000, 0x35980000, 0x35a00000, 0x35a80000, 0x35b00000, 0x35b80000, 0x35c00000, 0x35c80000, 0x35d00000, 0x35d80000, 0x35e00000, 0x35e80000, 0x35f00000, 0x35f80000, 0x36000000, 0x36040000, 0x36080000, 0x360c0000, 0x36100000, 0x36140000, 0x36180000, 0x361c0000, 0x36200000, 0x36240000, 0x36280000, 0x362c0000, 0x36300000, 0x36340000, 0x36380000, 0x363c0000, 0x36400000, 0x36440000, 0x36480000, 0x364c0000, 0x36500000, 0x36540000, 0x36580000, 0x365c0000, 0x36600000, 0x36640000, 0x36680000, 0x366c0000, 0x36700000, 0x36740000, 0x36780000, 0x367c0000, 0x36800000, 0x36820000, 0x36840000, 0x36860000, 0x36880000, 0x368a0000, 0x368c0000, 0x368e0000, 0x36900000, 0x36920000, 0x36940000, 0x36960000, 0x36980000, 0x369a0000, 0x369c0000, 0x369e0000, 0x36a00000, 0x36a20000, 0x36a40000, 0x36a60000, 0x36a80000, 0x36aa0000, 0x36ac0000, 0x36ae0000, 0x36b00000, 0x36b20000, 0x36b40000, 0x36b60000, 0x36b80000, 0x36ba0000, 0x36bc0000, 0x36be0000, 0x36c00000, 0x36c20000, 0x36c40000, 0x36c60000, 0x36c80000, 0x36ca0000, 0x36cc0000, 0x36ce0000, 0x36d00000, 0x36d20000, 0x36d40000, 0x36d60000, 0x36d80000, 0x36da0000, 0x36dc0000, 0x36de0000, 0x36e00000, 0x36e20000, 0x36e40000, 0x36e60000, 0x36e80000, 0x36ea0000, 0x36ec0000, 0x36ee0000, 0x36f00000, 0x36f20000, 0x36f40000, 0x36f60000, 0x36f80000, 0x36fa0000, 0x36fc0000, 0x36fe0000, 0x37000000, 0x37010000, 0x37020000, 0x37030000, 0x37040000, 0x37050000, 0x37060000, 0x37070000, 0x37080000, 0x37090000, 0x370a0000, 0x370b0000, 0x370c0000, 0x370d0000, 0x370e0000, 0x370f0000, 0x37100000, 0x37110000, 0x37120000, 0x37130000, 0x37140000, 0x37150000, 0x37160000, 0x37170000, 0x37180000, 0x37190000, 0x371a0000, 0x371b0000, 0x371c0000, 0x371d0000, 0x371e0000, 0x371f0000, 0x37200000, 0x37210000, 0x37220000, 0x37230000, 0x37240000, 0x37250000, 0x37260000, 0x37270000, 0x37280000, 0x37290000, 0x372a0000, 0x372b0000, 0x372c0000, 0x372d0000, 0x372e0000, 0x372f0000, 0x37300000, 0x37310000, 0x37320000, 0x37330000, 0x37340000, 0x37350000, 0x37360000, 0x37370000, 0x37380000, 0x37390000, 0x373a0000, 0x373b0000, 0x373c0000, 0x373d0000, 0x373e0000, 0x373f0000, 0x37400000, 0x37410000, 0x37420000, 0x37430000, 0x37440000, 0x37450000, 0x37460000, 0x37470000, 0x37480000, 0x37490000, 0x374a0000, 0x374b0000, 0x374c0000, 0x374d0000, 0x374e0000, 0x374f0000, 0x37500000, 0x37510000, 0x37520000, 0x37530000, 0x37540000, 0x37550000, 0x37560000, 0x37570000, 0x37580000, 0x37590000, 0x375a0000, 0x375b0000, 0x375c0000, 0x375d0000, 0x375e0000, 0x375f0000, 0x37600000, 0x37610000, 0x37620000, 0x37630000, 0x37640000, 0x37650000, 0x37660000, 0x37670000, 0x37680000, 0x37690000, 0x376a0000, 0x376b0000, 0x376c0000, 0x376d0000, 0x376e0000, 0x376f0000, 0x37700000, 0x37710000, 0x37720000, 0x37730000, 0x37740000, 0x37750000, 0x37760000, 0x37770000, 0x37780000, 0x37790000, 0x377a0000, 0x377b0000, 0x377c0000, 0x377d0000, 0x377e0000, 0x377f0000, 0x37800000, 0x37808000, 0x37810000, 0x37818000, 0x37820000, 0x37828000, 0x37830000, 0x37838000, 0x37840000, 0x37848000, 0x37850000, 0x37858000, 0x37860000, 0x37868000, 0x37870000, 0x37878000, 0x37880000, 0x37888000, 0x37890000, 0x37898000, 0x378a0000, 0x378a8000, 0x378b0000, 0x378b8000, 0x378c0000, 0x378c8000, 0x378d0000, 0x378d8000, 0x378e0000, 0x378e8000, 0x378f0000, 0x378f8000, 0x37900000, 0x37908000, 0x37910000, 0x37918000, 0x37920000, 0x37928000, 0x37930000, 0x37938000, 0x37940000, 0x37948000, 0x37950000, 0x37958000, 0x37960000, 0x37968000, 0x37970000, 0x37978000, 0x37980000, 0x37988000, 0x37990000, 0x37998000, 0x379a0000, 0x379a8000, 0x379b0000, 0x379b8000, 0x379c0000, 0x379c8000, 0x379d0000, 0x379d8000, 0x379e0000, 0x379e8000, 0x379f0000, 0x379f8000, 0x37a00000, 0x37a08000, 0x37a10000, 0x37a18000, 0x37a20000, 0x37a28000, 0x37a30000, 0x37a38000, 0x37a40000, 0x37a48000, 0x37a50000, 0x37a58000, 0x37a60000, 0x37a68000, 0x37a70000, 0x37a78000, 0x37a80000, 0x37a88000, 0x37a90000, 0x37a98000, 0x37aa0000, 0x37aa8000, 0x37ab0000, 0x37ab8000, 0x37ac0000, 0x37ac8000, 0x37ad0000, 0x37ad8000, 0x37ae0000, 0x37ae8000, 0x37af0000, 0x37af8000, 0x37b00000, 0x37b08000, 0x37b10000, 0x37b18000, 0x37b20000, 0x37b28000, 0x37b30000, 0x37b38000, 0x37b40000, 0x37b48000, 0x37b50000, 0x37b58000, 0x37b60000, 0x37b68000, 0x37b70000, 0x37b78000, 0x37b80000, 0x37b88000, 0x37b90000, 0x37b98000, 0x37ba0000, 0x37ba8000, 0x37bb0000, 0x37bb8000, 0x37bc0000, 0x37bc8000, 0x37bd0000, 0x37bd8000, 0x37be0000, 0x37be8000, 0x37bf0000, 0x37bf8000, 0x37c00000, 0x37c08000, 0x37c10000, 0x37c18000, 0x37c20000, 0x37c28000, 0x37c30000, 0x37c38000, 0x37c40000, 0x37c48000, 0x37c50000, 0x37c58000, 0x37c60000, 0x37c68000, 0x37c70000, 0x37c78000, 0x37c80000, 0x37c88000, 0x37c90000, 0x37c98000, 0x37ca0000, 0x37ca8000, 0x37cb0000, 0x37cb8000, 0x37cc0000, 0x37cc8000, 0x37cd0000, 0x37cd8000, 0x37ce0000, 0x37ce8000, 0x37cf0000, 0x37cf8000, 0x37d00000, 0x37d08000, 0x37d10000, 0x37d18000, 0x37d20000, 0x37d28000, 0x37d30000, 0x37d38000, 0x37d40000, 0x37d48000, 0x37d50000, 0x37d58000, 0x37d60000, 0x37d68000, 0x37d70000, 0x37d78000, 0x37d80000, 0x37d88000, 0x37d90000, 0x37d98000, 0x37da0000, 0x37da8000, 0x37db0000, 0x37db8000, 0x37dc0000, 0x37dc8000, 0x37dd0000, 0x37dd8000, 0x37de0000, 0x37de8000, 0x37df0000, 0x37df8000, 0x37e00000, 0x37e08000, 0x37e10000, 0x37e18000, 0x37e20000, 0x37e28000, 0x37e30000, 0x37e38000, 0x37e40000, 0x37e48000, 0x37e50000, 0x37e58000, 0x37e60000, 0x37e68000, 0x37e70000, 0x37e78000, 0x37e80000, 0x37e88000, 0x37e90000, 0x37e98000, 0x37ea0000, 0x37ea8000, 0x37eb0000, 0x37eb8000, 0x37ec0000, 0x37ec8000, 0x37ed0000, 0x37ed8000, 0x37ee0000, 0x37ee8000, 0x37ef0000, 0x37ef8000, 0x37f00000, 0x37f08000, 0x37f10000, 0x37f18000, 0x37f20000, 0x37f28000, 0x37f30000, 0x37f38000, 0x37f40000, 0x37f48000, 0x37f50000, 0x37f58000, 0x37f60000, 0x37f68000, 0x37f70000, 0x37f78000, 0x37f80000, 0x37f88000, 0x37f90000, 0x37f98000, 0x37fa0000, 0x37fa8000, 0x37fb0000, 0x37fb8000, 0x37fc0000, 0x37fc8000, 0x37fd0000, 0x37fd8000, 0x37fe0000, 0x37fe8000, 0x37ff0000, 0x37ff8000, 0x38000000, 0x38004000, 0x38008000, 0x3800c000, 0x38010000, 0x38014000, 0x38018000, 0x3801c000, 0x38020000, 0x38024000, 0x38028000, 0x3802c000, 0x38030000, 0x38034000, 0x38038000, 0x3803c000, 0x38040000, 0x38044000, 0x38048000, 0x3804c000, 0x38050000, 0x38054000, 0x38058000, 0x3805c000, 0x38060000, 0x38064000, 0x38068000, 0x3806c000, 0x38070000, 0x38074000, 0x38078000, 0x3807c000, 0x38080000, 0x38084000, 0x38088000, 0x3808c000, 0x38090000, 0x38094000, 0x38098000, 0x3809c000, 0x380a0000, 0x380a4000, 0x380a8000, 0x380ac000, 0x380b0000, 0x380b4000, 0x380b8000, 0x380bc000, 0x380c0000, 0x380c4000, 0x380c8000, 0x380cc000, 0x380d0000, 0x380d4000, 0x380d8000, 0x380dc000, 0x380e0000, 0x380e4000, 0x380e8000, 0x380ec000, 0x380f0000, 0x380f4000, 0x380f8000, 0x380fc000, 0x38100000, 0x38104000, 0x38108000, 0x3810c000, 0x38110000, 0x38114000, 0x38118000, 0x3811c000, 0x38120000, 0x38124000, 0x38128000, 0x3812c000, 0x38130000, 0x38134000, 0x38138000, 0x3813c000, 0x38140000, 0x38144000, 0x38148000, 0x3814c000, 0x38150000, 0x38154000, 0x38158000, 0x3815c000, 0x38160000, 0x38164000, 0x38168000, 0x3816c000, 0x38170000, 0x38174000, 0x38178000, 0x3817c000, 0x38180000, 0x38184000, 0x38188000, 0x3818c000, 0x38190000, 0x38194000, 0x38198000, 0x3819c000, 0x381a0000, 0x381a4000, 0x381a8000, 0x381ac000, 0x381b0000, 0x381b4000, 0x381b8000, 0x381bc000, 0x381c0000, 0x381c4000, 0x381c8000, 0x381cc000, 0x381d0000, 0x381d4000, 0x381d8000, 0x381dc000, 0x381e0000, 0x381e4000, 0x381e8000, 0x381ec000, 0x381f0000, 0x381f4000, 0x381f8000, 0x381fc000, 0x38200000, 0x38204000, 0x38208000, 0x3820c000, 0x38210000, 0x38214000, 0x38218000, 0x3821c000, 0x38220000, 0x38224000, 0x38228000, 0x3822c000, 0x38230000, 0x38234000, 0x38238000, 0x3823c000, 0x38240000, 0x38244000, 0x38248000, 0x3824c000, 0x38250000, 0x38254000, 0x38258000, 0x3825c000, 0x38260000, 0x38264000, 0x38268000, 0x3826c000, 0x38270000, 0x38274000, 0x38278000, 0x3827c000, 0x38280000, 0x38284000, 0x38288000, 0x3828c000, 0x38290000, 0x38294000, 0x38298000, 0x3829c000, 0x382a0000, 0x382a4000, 0x382a8000, 0x382ac000, 0x382b0000, 0x382b4000, 0x382b8000, 0x382bc000, 0x382c0000, 0x382c4000, 0x382c8000, 0x382cc000, 0x382d0000, 0x382d4000, 0x382d8000, 0x382dc000, 0x382e0000, 0x382e4000, 0x382e8000, 0x382ec000, 0x382f0000, 0x382f4000, 0x382f8000, 0x382fc000, 0x38300000, 0x38304000, 0x38308000, 0x3830c000, 0x38310000, 0x38314000, 0x38318000, 0x3831c000, 0x38320000, 0x38324000, 0x38328000, 0x3832c000, 0x38330000, 0x38334000, 0x38338000, 0x3833c000, 0x38340000, 0x38344000, 0x38348000, 0x3834c000, 0x38350000, 0x38354000, 0x38358000, 0x3835c000, 0x38360000, 0x38364000, 0x38368000, 0x3836c000, 0x38370000, 0x38374000, 0x38378000, 0x3837c000, 0x38380000, 0x38384000, 0x38388000, 0x3838c000, 0x38390000, 0x38394000, 0x38398000, 0x3839c000, 0x383a0000, 0x383a4000, 0x383a8000, 0x383ac000, 0x383b0000, 0x383b4000, 0x383b8000, 0x383bc000, 0x383c0000, 0x383c4000, 0x383c8000, 0x383cc000, 0x383d0000, 0x383d4000, 0x383d8000, 0x383dc000, 0x383e0000, 0x383e4000, 0x383e8000, 0x383ec000, 0x383f0000, 0x383f4000, 0x383f8000, 0x383fc000, 0x38400000, 0x38404000, 0x38408000, 0x3840c000, 0x38410000, 0x38414000, 0x38418000, 0x3841c000, 0x38420000, 0x38424000, 0x38428000, 0x3842c000, 0x38430000, 0x38434000, 0x38438000, 0x3843c000, 0x38440000, 0x38444000, 0x38448000, 0x3844c000, 0x38450000, 0x38454000, 0x38458000, 0x3845c000, 0x38460000, 0x38464000, 0x38468000, 0x3846c000, 0x38470000, 0x38474000, 0x38478000, 0x3847c000, 0x38480000, 0x38484000, 0x38488000, 0x3848c000, 0x38490000, 0x38494000, 0x38498000, 0x3849c000, 0x384a0000, 0x384a4000, 0x384a8000, 0x384ac000, 0x384b0000, 0x384b4000, 0x384b8000, 0x384bc000, 0x384c0000, 0x384c4000, 0x384c8000, 0x384cc000, 0x384d0000, 0x384d4000, 0x384d8000, 0x384dc000, 0x384e0000, 0x384e4000, 0x384e8000, 0x384ec000, 0x384f0000, 0x384f4000, 0x384f8000, 0x384fc000, 0x38500000, 0x38504000, 0x38508000, 0x3850c000, 0x38510000, 0x38514000, 0x38518000, 0x3851c000, 0x38520000, 0x38524000, 0x38528000, 0x3852c000, 0x38530000, 0x38534000, 0x38538000, 0x3853c000, 0x38540000, 0x38544000, 0x38548000, 0x3854c000, 0x38550000, 0x38554000, 0x38558000, 0x3855c000, 0x38560000, 0x38564000, 0x38568000, 0x3856c000, 0x38570000, 0x38574000, 0x38578000, 0x3857c000, 0x38580000, 0x38584000, 0x38588000, 0x3858c000, 0x38590000, 0x38594000, 0x38598000, 0x3859c000, 0x385a0000, 0x385a4000, 0x385a8000, 0x385ac000, 0x385b0000, 0x385b4000, 0x385b8000, 0x385bc000, 0x385c0000, 0x385c4000, 0x385c8000, 0x385cc000, 0x385d0000, 0x385d4000, 0x385d8000, 0x385dc000, 0x385e0000, 0x385e4000, 0x385e8000, 0x385ec000, 0x385f0000, 0x385f4000, 0x385f8000, 0x385fc000, 0x38600000, 0x38604000, 0x38608000, 0x3860c000, 0x38610000, 0x38614000, 0x38618000, 0x3861c000, 0x38620000, 0x38624000, 0x38628000, 0x3862c000, 0x38630000, 0x38634000, 0x38638000, 0x3863c000, 0x38640000, 0x38644000, 0x38648000, 0x3864c000, 0x38650000, 0x38654000, 0x38658000, 0x3865c000, 0x38660000, 0x38664000, 0x38668000, 0x3866c000, 0x38670000, 0x38674000, 0x38678000, 0x3867c000, 0x38680000, 0x38684000, 0x38688000, 0x3868c000, 0x38690000, 0x38694000, 0x38698000, 0x3869c000, 0x386a0000, 0x386a4000, 0x386a8000, 0x386ac000, 0x386b0000, 0x386b4000, 0x386b8000, 0x386bc000, 0x386c0000, 0x386c4000, 0x386c8000, 0x386cc000, 0x386d0000, 0x386d4000, 0x386d8000, 0x386dc000, 0x386e0000, 0x386e4000, 0x386e8000, 0x386ec000, 0x386f0000, 0x386f4000, 0x386f8000, 0x386fc000, 0x38700000, 0x38704000, 0x38708000, 0x3870c000, 0x38710000, 0x38714000, 0x38718000, 0x3871c000, 0x38720000, 0x38724000, 0x38728000, 0x3872c000, 0x38730000, 0x38734000, 0x38738000, 0x3873c000, 0x38740000, 0x38744000, 0x38748000, 0x3874c000, 0x38750000, 0x38754000, 0x38758000, 0x3875c000, 0x38760000, 0x38764000, 0x38768000, 0x3876c000, 0x38770000, 0x38774000, 0x38778000, 0x3877c000, 0x38780000, 0x38784000, 0x38788000, 0x3878c000, 0x38790000, 0x38794000, 0x38798000, 0x3879c000, 0x387a0000, 0x387a4000, 0x387a8000, 0x387ac000, 0x387b0000, 0x387b4000, 0x387b8000, 0x387bc000, 0x387c0000, 0x387c4000, 0x387c8000, 0x387cc000, 0x387d0000, 0x387d4000, 0x387d8000, 0x387dc000, 0x387e0000, 0x387e4000, 0x387e8000, 0x387ec000, 0x387f0000, 0x387f4000, 0x387f8000, 0x387fc000, 0x38000000, 0x38002000, 0x38004000, 0x38006000, 0x38008000, 0x3800a000, 0x3800c000, 0x3800e000, 0x38010000, 0x38012000, 0x38014000, 0x38016000, 0x38018000, 0x3801a000, 0x3801c000, 0x3801e000, 0x38020000, 0x38022000, 0x38024000, 0x38026000, 0x38028000, 0x3802a000, 0x3802c000, 0x3802e000, 0x38030000, 0x38032000, 0x38034000, 0x38036000, 0x38038000, 0x3803a000, 0x3803c000, 0x3803e000, 0x38040000, 0x38042000, 0x38044000, 0x38046000, 0x38048000, 0x3804a000, 0x3804c000, 0x3804e000, 0x38050000, 0x38052000, 0x38054000, 0x38056000, 0x38058000, 0x3805a000, 0x3805c000, 0x3805e000, 0x38060000, 0x38062000, 0x38064000, 0x38066000, 0x38068000, 0x3806a000, 0x3806c000, 0x3806e000, 0x38070000, 0x38072000, 0x38074000, 0x38076000, 0x38078000, 0x3807a000, 0x3807c000, 0x3807e000, 0x38080000, 0x38082000, 0x38084000, 0x38086000, 0x38088000, 0x3808a000, 0x3808c000, 0x3808e000, 0x38090000, 0x38092000, 0x38094000, 0x38096000, 0x38098000, 0x3809a000, 0x3809c000, 0x3809e000, 0x380a0000, 0x380a2000, 0x380a4000, 0x380a6000, 0x380a8000, 0x380aa000, 0x380ac000, 0x380ae000, 0x380b0000, 0x380b2000, 0x380b4000, 0x380b6000, 0x380b8000, 0x380ba000, 0x380bc000, 0x380be000, 0x380c0000, 0x380c2000, 0x380c4000, 0x380c6000, 0x380c8000, 0x380ca000, 0x380cc000, 0x380ce000, 0x380d0000, 0x380d2000, 0x380d4000, 0x380d6000, 0x380d8000, 0x380da000, 0x380dc000, 0x380de000, 0x380e0000, 0x380e2000, 0x380e4000, 0x380e6000, 0x380e8000, 0x380ea000, 0x380ec000, 0x380ee000, 0x380f0000, 0x380f2000, 0x380f4000, 0x380f6000, 0x380f8000, 0x380fa000, 0x380fc000, 0x380fe000, 0x38100000, 0x38102000, 0x38104000, 0x38106000, 0x38108000, 0x3810a000, 0x3810c000, 0x3810e000, 0x38110000, 0x38112000, 0x38114000, 0x38116000, 0x38118000, 0x3811a000, 0x3811c000, 0x3811e000, 0x38120000, 0x38122000, 0x38124000, 0x38126000, 0x38128000, 0x3812a000, 0x3812c000, 0x3812e000, 0x38130000, 0x38132000, 0x38134000, 0x38136000, 0x38138000, 0x3813a000, 0x3813c000, 0x3813e000, 0x38140000, 0x38142000, 0x38144000, 0x38146000, 0x38148000, 0x3814a000, 0x3814c000, 0x3814e000, 0x38150000, 0x38152000, 0x38154000, 0x38156000, 0x38158000, 0x3815a000, 0x3815c000, 0x3815e000, 0x38160000, 0x38162000, 0x38164000, 0x38166000, 0x38168000, 0x3816a000, 0x3816c000, 0x3816e000, 0x38170000, 0x38172000, 0x38174000, 0x38176000, 0x38178000, 0x3817a000, 0x3817c000, 0x3817e000, 0x38180000, 0x38182000, 0x38184000, 0x38186000, 0x38188000, 0x3818a000, 0x3818c000, 0x3818e000, 0x38190000, 0x38192000, 0x38194000, 0x38196000, 0x38198000, 0x3819a000, 0x3819c000, 0x3819e000, 0x381a0000, 0x381a2000, 0x381a4000, 0x381a6000, 0x381a8000, 0x381aa000, 0x381ac000, 0x381ae000, 0x381b0000, 0x381b2000, 0x381b4000, 0x381b6000, 0x381b8000, 0x381ba000, 0x381bc000, 0x381be000, 0x381c0000, 0x381c2000, 0x381c4000, 0x381c6000, 0x381c8000, 0x381ca000, 0x381cc000, 0x381ce000, 0x381d0000, 0x381d2000, 0x381d4000, 0x381d6000, 0x381d8000, 0x381da000, 0x381dc000, 0x381de000, 0x381e0000, 0x381e2000, 0x381e4000, 0x381e6000, 0x381e8000, 0x381ea000, 0x381ec000, 0x381ee000, 0x381f0000, 0x381f2000, 0x381f4000, 0x381f6000, 0x381f8000, 0x381fa000, 0x381fc000, 0x381fe000, 0x38200000, 0x38202000, 0x38204000, 0x38206000, 0x38208000, 0x3820a000, 0x3820c000, 0x3820e000, 0x38210000, 0x38212000, 0x38214000, 0x38216000, 0x38218000, 0x3821a000, 0x3821c000, 0x3821e000, 0x38220000, 0x38222000, 0x38224000, 0x38226000, 0x38228000, 0x3822a000, 0x3822c000, 0x3822e000, 0x38230000, 0x38232000, 0x38234000, 0x38236000, 0x38238000, 0x3823a000, 0x3823c000, 0x3823e000, 0x38240000, 0x38242000, 0x38244000, 0x38246000, 0x38248000, 0x3824a000, 0x3824c000, 0x3824e000, 0x38250000, 0x38252000, 0x38254000, 0x38256000, 0x38258000, 0x3825a000, 0x3825c000, 0x3825e000, 0x38260000, 0x38262000, 0x38264000, 0x38266000, 0x38268000, 0x3826a000, 0x3826c000, 0x3826e000, 0x38270000, 0x38272000, 0x38274000, 0x38276000, 0x38278000, 0x3827a000, 0x3827c000, 0x3827e000, 0x38280000, 0x38282000, 0x38284000, 0x38286000, 0x38288000, 0x3828a000, 0x3828c000, 0x3828e000, 0x38290000, 0x38292000, 0x38294000, 0x38296000, 0x38298000, 0x3829a000, 0x3829c000, 0x3829e000, 0x382a0000, 0x382a2000, 0x382a4000, 0x382a6000, 0x382a8000, 0x382aa000, 0x382ac000, 0x382ae000, 0x382b0000, 0x382b2000, 0x382b4000, 0x382b6000, 0x382b8000, 0x382ba000, 0x382bc000, 0x382be000, 0x382c0000, 0x382c2000, 0x382c4000, 0x382c6000, 0x382c8000, 0x382ca000, 0x382cc000, 0x382ce000, 0x382d0000, 0x382d2000, 0x382d4000, 0x382d6000, 0x382d8000, 0x382da000, 0x382dc000, 0x382de000, 0x382e0000, 0x382e2000, 0x382e4000, 0x382e6000, 0x382e8000, 0x382ea000, 0x382ec000, 0x382ee000, 0x382f0000, 0x382f2000, 0x382f4000, 0x382f6000, 0x382f8000, 0x382fa000, 0x382fc000, 0x382fe000, 0x38300000, 0x38302000, 0x38304000, 0x38306000, 0x38308000, 0x3830a000, 0x3830c000, 0x3830e000, 0x38310000, 0x38312000, 0x38314000, 0x38316000, 0x38318000, 0x3831a000, 0x3831c000, 0x3831e000, 0x38320000, 0x38322000, 0x38324000, 0x38326000, 0x38328000, 0x3832a000, 0x3832c000, 0x3832e000, 0x38330000, 0x38332000, 0x38334000, 0x38336000, 0x38338000, 0x3833a000, 0x3833c000, 0x3833e000, 0x38340000, 0x38342000, 0x38344000, 0x38346000, 0x38348000, 0x3834a000, 0x3834c000, 0x3834e000, 0x38350000, 0x38352000, 0x38354000, 0x38356000, 0x38358000, 0x3835a000, 0x3835c000, 0x3835e000, 0x38360000, 0x38362000, 0x38364000, 0x38366000, 0x38368000, 0x3836a000, 0x3836c000, 0x3836e000, 0x38370000, 0x38372000, 0x38374000, 0x38376000, 0x38378000, 0x3837a000, 0x3837c000, 0x3837e000, 0x38380000, 0x38382000, 0x38384000, 0x38386000, 0x38388000, 0x3838a000, 0x3838c000, 0x3838e000, 0x38390000, 0x38392000, 0x38394000, 0x38396000, 0x38398000, 0x3839a000, 0x3839c000, 0x3839e000, 0x383a0000, 0x383a2000, 0x383a4000, 0x383a6000, 0x383a8000, 0x383aa000, 0x383ac000, 0x383ae000, 0x383b0000, 0x383b2000, 0x383b4000, 0x383b6000, 0x383b8000, 0x383ba000, 0x383bc000, 0x383be000, 0x383c0000, 0x383c2000, 0x383c4000, 0x383c6000, 0x383c8000, 0x383ca000, 0x383cc000, 0x383ce000, 0x383d0000, 0x383d2000, 0x383d4000, 0x383d6000, 0x383d8000, 0x383da000, 0x383dc000, 0x383de000, 0x383e0000, 0x383e2000, 0x383e4000, 0x383e6000, 0x383e8000, 0x383ea000, 0x383ec000, 0x383ee000, 0x383f0000, 0x383f2000, 0x383f4000, 0x383f6000, 0x383f8000, 0x383fa000, 0x383fc000, 0x383fe000, 0x38400000, 0x38402000, 0x38404000, 0x38406000, 0x38408000, 0x3840a000, 0x3840c000, 0x3840e000, 0x38410000, 0x38412000, 0x38414000, 0x38416000, 0x38418000, 0x3841a000, 0x3841c000, 0x3841e000, 0x38420000, 0x38422000, 0x38424000, 0x38426000, 0x38428000, 0x3842a000, 0x3842c000, 0x3842e000, 0x38430000, 0x38432000, 0x38434000, 0x38436000, 0x38438000, 0x3843a000, 0x3843c000, 0x3843e000, 0x38440000, 0x38442000, 0x38444000, 0x38446000, 0x38448000, 0x3844a000, 0x3844c000, 0x3844e000, 0x38450000, 0x38452000, 0x38454000, 0x38456000, 0x38458000, 0x3845a000, 0x3845c000, 0x3845e000, 0x38460000, 0x38462000, 0x38464000, 0x38466000, 0x38468000, 0x3846a000, 0x3846c000, 0x3846e000, 0x38470000, 0x38472000, 0x38474000, 0x38476000, 0x38478000, 0x3847a000, 0x3847c000, 0x3847e000, 0x38480000, 0x38482000, 0x38484000, 0x38486000, 0x38488000, 0x3848a000, 0x3848c000, 0x3848e000, 0x38490000, 0x38492000, 0x38494000, 0x38496000, 0x38498000, 0x3849a000, 0x3849c000, 0x3849e000, 0x384a0000, 0x384a2000, 0x384a4000, 0x384a6000, 0x384a8000, 0x384aa000, 0x384ac000, 0x384ae000, 0x384b0000, 0x384b2000, 0x384b4000, 0x384b6000, 0x384b8000, 0x384ba000, 0x384bc000, 0x384be000, 0x384c0000, 0x384c2000, 0x384c4000, 0x384c6000, 0x384c8000, 0x384ca000, 0x384cc000, 0x384ce000, 0x384d0000, 0x384d2000, 0x384d4000, 0x384d6000, 0x384d8000, 0x384da000, 0x384dc000, 0x384de000, 0x384e0000, 0x384e2000, 0x384e4000, 0x384e6000, 0x384e8000, 0x384ea000, 0x384ec000, 0x384ee000, 0x384f0000, 0x384f2000, 0x384f4000, 0x384f6000, 0x384f8000, 0x384fa000, 0x384fc000, 0x384fe000, 0x38500000, 0x38502000, 0x38504000, 0x38506000, 0x38508000, 0x3850a000, 0x3850c000, 0x3850e000, 0x38510000, 0x38512000, 0x38514000, 0x38516000, 0x38518000, 0x3851a000, 0x3851c000, 0x3851e000, 0x38520000, 0x38522000, 0x38524000, 0x38526000, 0x38528000, 0x3852a000, 0x3852c000, 0x3852e000, 0x38530000, 0x38532000, 0x38534000, 0x38536000, 0x38538000, 0x3853a000, 0x3853c000, 0x3853e000, 0x38540000, 0x38542000, 0x38544000, 0x38546000, 0x38548000, 0x3854a000, 0x3854c000, 0x3854e000, 0x38550000, 0x38552000, 0x38554000, 0x38556000, 0x38558000, 0x3855a000, 0x3855c000, 0x3855e000, 0x38560000, 0x38562000, 0x38564000, 0x38566000, 0x38568000, 0x3856a000, 0x3856c000, 0x3856e000, 0x38570000, 0x38572000, 0x38574000, 0x38576000, 0x38578000, 0x3857a000, 0x3857c000, 0x3857e000, 0x38580000, 0x38582000, 0x38584000, 0x38586000, 0x38588000, 0x3858a000, 0x3858c000, 0x3858e000, 0x38590000, 0x38592000, 0x38594000, 0x38596000, 0x38598000, 0x3859a000, 0x3859c000, 0x3859e000, 0x385a0000, 0x385a2000, 0x385a4000, 0x385a6000, 0x385a8000, 0x385aa000, 0x385ac000, 0x385ae000, 0x385b0000, 0x385b2000, 0x385b4000, 0x385b6000, 0x385b8000, 0x385ba000, 0x385bc000, 0x385be000, 0x385c0000, 0x385c2000, 0x385c4000, 0x385c6000, 0x385c8000, 0x385ca000, 0x385cc000, 0x385ce000, 0x385d0000, 0x385d2000, 0x385d4000, 0x385d6000, 0x385d8000, 0x385da000, 0x385dc000, 0x385de000, 0x385e0000, 0x385e2000, 0x385e4000, 0x385e6000, 0x385e8000, 0x385ea000, 0x385ec000, 0x385ee000, 0x385f0000, 0x385f2000, 0x385f4000, 0x385f6000, 0x385f8000, 0x385fa000, 0x385fc000, 0x385fe000, 0x38600000, 0x38602000, 0x38604000, 0x38606000, 0x38608000, 0x3860a000, 0x3860c000, 0x3860e000, 0x38610000, 0x38612000, 0x38614000, 0x38616000, 0x38618000, 0x3861a000, 0x3861c000, 0x3861e000, 0x38620000, 0x38622000, 0x38624000, 0x38626000, 0x38628000, 0x3862a000, 0x3862c000, 0x3862e000, 0x38630000, 0x38632000, 0x38634000, 0x38636000, 0x38638000, 0x3863a000, 0x3863c000, 0x3863e000, 0x38640000, 0x38642000, 0x38644000, 0x38646000, 0x38648000, 0x3864a000, 0x3864c000, 0x3864e000, 0x38650000, 0x38652000, 0x38654000, 0x38656000, 0x38658000, 0x3865a000, 0x3865c000, 0x3865e000, 0x38660000, 0x38662000, 0x38664000, 0x38666000, 0x38668000, 0x3866a000, 0x3866c000, 0x3866e000, 0x38670000, 0x38672000, 0x38674000, 0x38676000, 0x38678000, 0x3867a000, 0x3867c000, 0x3867e000, 0x38680000, 0x38682000, 0x38684000, 0x38686000, 0x38688000, 0x3868a000, 0x3868c000, 0x3868e000, 0x38690000, 0x38692000, 0x38694000, 0x38696000, 0x38698000, 0x3869a000, 0x3869c000, 0x3869e000, 0x386a0000, 0x386a2000, 0x386a4000, 0x386a6000, 0x386a8000, 0x386aa000, 0x386ac000, 0x386ae000, 0x386b0000, 0x386b2000, 0x386b4000, 0x386b6000, 0x386b8000, 0x386ba000, 0x386bc000, 0x386be000, 0x386c0000, 0x386c2000, 0x386c4000, 0x386c6000, 0x386c8000, 0x386ca000, 0x386cc000, 0x386ce000, 0x386d0000, 0x386d2000, 0x386d4000, 0x386d6000, 0x386d8000, 0x386da000, 0x386dc000, 0x386de000, 0x386e0000, 0x386e2000, 0x386e4000, 0x386e6000, 0x386e8000, 0x386ea000, 0x386ec000, 0x386ee000, 0x386f0000, 0x386f2000, 0x386f4000, 0x386f6000, 0x386f8000, 0x386fa000, 0x386fc000, 0x386fe000, 0x38700000, 0x38702000, 0x38704000, 0x38706000, 0x38708000, 0x3870a000, 0x3870c000, 0x3870e000, 0x38710000, 0x38712000, 0x38714000, 0x38716000, 0x38718000, 0x3871a000, 0x3871c000, 0x3871e000, 0x38720000, 0x38722000, 0x38724000, 0x38726000, 0x38728000, 0x3872a000, 0x3872c000, 0x3872e000, 0x38730000, 0x38732000, 0x38734000, 0x38736000, 0x38738000, 0x3873a000, 0x3873c000, 0x3873e000, 0x38740000, 0x38742000, 0x38744000, 0x38746000, 0x38748000, 0x3874a000, 0x3874c000, 0x3874e000, 0x38750000, 0x38752000, 0x38754000, 0x38756000, 0x38758000, 0x3875a000, 0x3875c000, 0x3875e000, 0x38760000, 0x38762000, 0x38764000, 0x38766000, 0x38768000, 0x3876a000, 0x3876c000, 0x3876e000, 0x38770000, 0x38772000, 0x38774000, 0x38776000, 0x38778000, 0x3877a000, 0x3877c000, 0x3877e000, 0x38780000, 0x38782000, 0x38784000, 0x38786000, 0x38788000, 0x3878a000, 0x3878c000, 0x3878e000, 0x38790000, 0x38792000, 0x38794000, 0x38796000, 0x38798000, 0x3879a000, 0x3879c000, 0x3879e000, 0x387a0000, 0x387a2000, 0x387a4000, 0x387a6000, 0x387a8000, 0x387aa000, 0x387ac000, 0x387ae000, 0x387b0000, 0x387b2000, 0x387b4000, 0x387b6000, 0x387b8000, 0x387ba000, 0x387bc000, 0x387be000, 0x387c0000, 0x387c2000, 0x387c4000, 0x387c6000, 0x387c8000, 0x387ca000, 0x387cc000, 0x387ce000, 0x387d0000, 0x387d2000, 0x387d4000, 0x387d6000, 0x387d8000, 0x387da000, 0x387dc000, 0x387de000, 0x387e0000, 0x387e2000, 0x387e4000, 0x387e6000, 0x387e8000, 0x387ea000, 0x387ec000, 0x387ee000, 0x387f0000, 0x387f2000, 0x387f4000, 0x387f6000, 0x387f8000, 0x387fa000, 0x387fc000, 0x387fe000};

static uint32_t exponenttable[64]={0x0, 0x800000, 0x1000000, 0x1800000, 0x2000000, 0x2800000, 0x3000000, 0x3800000, 0x4000000, 0x4800000, 0x5000000, 0x5800000, 0x6000000, 0x6800000, 0x7000000, 0x7800000, 0x8000000, 0x8800000, 0x9000000, 0x9800000, 0xa000000, 0xa800000, 0xb000000, 0xb800000, 0xc000000, 0xc800000, 0xd000000, 0xd800000, 0xe000000, 0xe800000, 0xf000000, 0x47800000, 0x80000000, 0x80800000, 0x81000000, 0x81800000, 0x82000000, 0x82800000, 0x83000000, 0x83800000, 0x84000000, 0x84800000, 0x85000000, 0x85800000, 0x86000000, 0x86800000, 0x87000000, 0x87800000, 0x88000000, 0x88800000, 0x89000000, 0x89800000, 0x8a000000, 0x8a800000, 0x8b000000, 0x8b800000, 0x8c000000, 0x8c800000, 0x8d000000, 0x8d800000, 0x8e000000, 0x8e800000, 0x8f000000, 0xc7800000};

static uint16_t offsettable[64]={0x0, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x0, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400, 0x400};


// add by hou for HALF float operate

uint16_t tc_pw_flt2half(int32_t f)
{
    return basetable[(f>>23)&0x1ff]+((f&0x007fffff)>>shifttable[(f>>23)&0x1ff]);
    
}

int32_t tc_pw_half2flt(uint16_t h)
{
    return mantissatable[offsettable[h>>10]+(h&0x3ff)]+exponenttable[h>>10];
}
//

/**
 * Reinterpret a 32-bit integer as a float.
 */
float tc_pw_int2float(uint32_t i)
{
    union tc_pw_intfloat32 v;
    v.i = i;
    return v.f;
}

/**
 * Reinterpret a float as a 32-bit integer.
 */
uint32_t tc_pw_float2int(float f)
{
    union tc_pw_intfloat32 v;
    v.f = f;
    return v.i;
}


/**
 * convert half float (uint16_t) to float.
 */
float tc_pw_half2float(uint16_t i)
{
    uint32_t single_float = tc_pw_half2flt(i);
    
    return tc_pw_int2float(single_float);
}

/**
 * Reinterpret a float as a half float (uint16_t).
 */
uint16_t tc_pw_float2half(float f)
{
    //first convert a float to uint32_t
    uint32_t single_float = tc_pw_float2int(f);
    
    return tc_pw_flt2half(single_float);
}

/**
 * Reinterpret a 64-bit integer as a double.
 */
double tc_pw_int2double(uint64_t i)
{
    union tc_pw_intfloat64 v;
    v.i = i;
    return v.f;
}

/**
 * Reinterpret a double as a 64-bit integer.
 */
uint64_t tc_pw_double2int(double f)
{
    union tc_pw_intfloat64 v;
    v.f = f;
    return v.i;
}



//time code

int PW_HMSF_To_Frames(     int lHr,
                           int lMn,
                           int lSc,
                           int lFr,
                          TCBASERATE  TCBASERATEx,
                          TCTYPE  TCTYPEx,
                           int* plFramesResult)
{
 
///////////////////////////////////////////////////////
// convert hh:mm:ss:ff to frames
 
// params -
//
//  int lHours - input hours
//  int lMins - input minutes
//  int lSecs - input seconds
//  int lFrames - input frames
 
///////////////////////////////////////////////////////
 
int iRet = 0; // no error handling provided
 
 int lFramesCalc = 0;
 
if( TCBASERATEx ==  TCBASERATE_30FPS)
  {
  if( TCTYPEx ==  TCTYPE_FIELD1_NON_DROP_FRAME
      ||  TCTYPEx ==  TCTYPE_FIELD2_NON_DROP_FRAME)
    {
    // convert as 30 fps non-drop frame
 
    lFramesCalc =  lHr  * 108000;    // 30 * 60 * 60 non-drop frames in 1 hour
    lFramesCalc += lMn  * 1800;      // 30 * 60 non-drop frames in one minute
    lFramesCalc += lSc  * 30;        // 30 non-drop frames in one second
    lFramesCalc += lFr;              // frames
 
    }
  else if( TCTYPEx ==  TCTYPE_FIELD1_DROP_FRAME
      ||  TCTYPEx ==  TCTYPE_FIELD2_DROP_FRAME)
    {
    // convert as 30 fps drop-frame
 
    lFramesCalc =  lHr  * 107892;    // ((30 * 60 - 2) * 10 + 2) * 6 drop-frame frames in 1 hour
    lFramesCalc += lMn  * 1798;      // 30 * 60 - 2 drop-frame frames in one minute
    lFramesCalc += (lMn / 10) * 2;  // for each minute except each 10th minute add 2 frames
    lFramesCalc += lSc  * 30;        // 30 drop-frame frames in one second
    lFramesCalc += lFr;              // frames
 
    }
  }
else if( TCBASERATEx ==  TCBASERATE_25FPS)
  {
  if( TCTYPEx ==  TCTYPE_FIELD1_NON_DROP_FRAME
      ||  TCTYPEx ==  TCTYPE_FIELD2_NON_DROP_FRAME)
    {
    // convert as 25 fps non-drop frame
 
    lFramesCalc =  lHr  * 90000;    // 25 * 60 * 60 non-drop frames in 1 hour
    lFramesCalc += lMn  * 1500;      // 25 * 60 non-drop frames in one minute
    lFramesCalc += lSc  * 25;        // 25 non-drop frames in one second
    lFramesCalc += lFr;              // frames
 
    }
  else
    {
    // drop-frame couting mode is not supported for 25 fps
    }
  }
else if( TCBASERATEx ==  TCBASERATE_24FPS)
  {
  if( TCTYPEx ==  TCTYPE_FIELD1_NON_DROP_FRAME
      ||  TCTYPEx ==  TCTYPE_FIELD2_NON_DROP_FRAME)
    {
    // convert as 24 fps non-drop frame
    lFramesCalc =  lHr  * 86400;    // 24 * 60 * 60 non-drop frames in 1 hour
    lFramesCalc += lMn  * 1440;      // 24 * 60 non-drop frames in one minute
    lFramesCalc += lSc  * 24;        // 24 non-drop frames in one second
    lFramesCalc += lFr;              // frames
    }
  else
    {
    // drop-frame couting mode is not supported for 24 fps
    }
  }
 
*plFramesResult = lFramesCalc;
 
return iRet;
 
}


int  PW_TextTC_To_Frames( char* sTimecode,
                          TCBASERATE  TCBASERATEx,
                          int* plFramesResult)
{
    int iRet = 0; // no error handling provided
      
    // parse the timecode string to obtain hh:mm:ss:ff values as integers
    // atol() stops reading the string at any non-numeric character
    // so the separators in 00:00:00:00 conveniently terminate each field
     int lHours = atoi(sTimecode + 0);    // xx:00:00:00
     int lMins = atoi(sTimecode + 3);    // 00:xx:00:00
     int lSecs = atoi(sTimecode + 6);    // 00:00:xx:00
     int lFrames = atoi(sTimecode + 9);  // 00:00:00:xx
     
    // get the  TCTYPE from the string
     TCTYPE  TCTYPEx =  TCTYPE_NOT_SET;
    char cTcType = sTimecode[8]; // last separator
    if(cTcType == '.')      // period
     
     TCTYPEx =  TCTYPE_FIELD1_NON_DROP_FRAME;

    else if(cTcType == ':')  // colon
       TCTYPEx =  TCTYPE_FIELD2_NON_DROP_FRAME;
    else if(cTcType == ',')  // comma
       TCTYPEx =  TCTYPE_FIELD1_DROP_FRAME;
    else if(cTcType == ';')  // semicolon
       TCTYPEx =  TCTYPE_FIELD2_DROP_FRAME;
     
     int lFramesResult = 0;
     
     PW_HMSF_To_Frames(  lHours,
                          lMins,
                          lSecs,
                          lFrames,
                           TCBASERATEx,
                           TCTYPEx,
                          &lFramesResult);
     
    *plFramesResult = lFramesResult;
     
    return iRet;
}


int PW_Frames_To_HMSF(   int lFrames,
                           TCBASERATE  TCBASERATEx,
                           TCTYPE  TCTYPEx,
                           int* plHrResult,
                           int* plMnResult,
                           int* plScResult,
                           int* plFrResult)
{
///////////////////////////////////////////////////////
// convert frames to hh mm ss ff
//
// Return -
// Returns 0;  // no error handling provided
///////////////////////////////////////////////////////
 
 int iRet = 0; // no error handling provided
 
 int lHr = 0;
 int lMn = 0;
 int lSc = 0;
 int lFr = 0;
 
 int lQuot = 0;
 int lRem = 0;
 
if( TCBASERATEx ==  TCBASERATE_30FPS)
  {
  if( TCTYPEx ==  TCTYPE_FIELD1_NON_DROP_FRAME
      ||  TCTYPEx ==  TCTYPE_FIELD2_NON_DROP_FRAME)
    {
    // convert as 30 fps non-drop frame
 
    #ifdef USE_24HOUR_ROLLOVER
    if(lFrames >= 2592000)     // 24 hour rollover
      lFrames -= 2592000;
    #endif // #ifdef USE_24HOUR_ROLLOVER
 
    // HOURS /////////////////
    lQuot = lFrames / 108000;  // frames in non-drop-frame hour
    lRem = lFrames % 108000;
    lHr = lQuot;
 
    // MINUTES /////////////////
    lQuot = lRem / 1800;      // frames in non-drop-frame minute
    lRem = lRem % 1800;
    lMn = lQuot;
 
    // SECONDS //////////////
    lQuot = lRem / 30;        // frames in non-drop-frame second
    lRem = lRem % 30;
    lSc = lQuot;
 
    // FRAMES ///////////////
    lFr = lRem;
 
    // return results
    *plHrResult = lHr;
    *plMnResult = lMn;
    *plScResult = lSc;
    *plFrResult = lFr;
 
    }
  else if( TCTYPEx ==  TCTYPE_FIELD1_DROP_FRAME
      ||  TCTYPEx ==  TCTYPE_FIELD2_DROP_FRAME)
    {
    // convert as 30 fps drop-frame
 
    #ifdef USE_24HOUR_ROLLOVER
    if(lFrames >= 2589408)     // 24 hour rollover
      lFrames -= 2589408;
    #endif // #ifdef USE_24HOUR_ROLLOVER
 
     int lCross10x2 = 0;  // crossed 10 minutes
     int lEven10 = 0;    // is even 10 minutes
 
    // HOURS ///////////////////
    lQuot = lFrames / 107892;  // frames in drop-frame hour
    lRem = lFrames % 107892;
    lHr = lQuot;
 
    // MINUTES /////////////////
    lQuot = lRem / 1798;      // frames in drop-frame minute
    lRem = lRem % 1798;
    lCross10x2 = (lQuot / 10) * 2;  // calc two frames for each 10 minute crossing
    lEven10 = lQuot % 10;            // calc is even 10th minute
 
    if(lRem < (lCross10x2) && lEven10 == 0)
    {
          lQuot -= 1;
          lRem += (1798 + 2) - (lCross10x2);
    }
    else
    {
        if(lRem < ((lCross10x2) + 2) && lEven10 != 0)
        {
            lQuot -= 1;
            lRem += 1798 - (lCross10x2);
        }
        else
        {
            //lQuot = lQuot;
            lRem -= (lCross10x2);
        }
      }
    lMn = lQuot;  // minute
 
    // SECONDS //////////////
    lQuot = lRem / 30;
    lRem = lRem % 30;
    lSc = lQuot;
 
    // FRAMES ///////////////
    lFr = lRem;
 
    // return results
    *plHrResult = lHr;
    *plMnResult = lMn;
    *plScResult = lSc;
    *plFrResult = lFr;
 
    }
  }
else if( TCBASERATEx ==  TCBASERATE_25FPS)
  {
  if( TCTYPEx ==  TCTYPE_FIELD1_NON_DROP_FRAME
      ||  TCTYPEx ==  TCTYPE_FIELD2_NON_DROP_FRAME)
    {
    // convert as 25 fps non-drop frame
 
    #ifdef USE_24HOUR_ROLLOVER
    if(lFrames >= 2160000)     // 24 hour rollover
      lFrames -= 2160000;
    #endif // #ifdef USE_24HOUR_ROLLOVER
 
    // HOURS /////////////////
    lQuot = lFrames / 90000;  // frames in non-drop-frame hour
    lRem = lFrames % 90000;
    lHr = lQuot;
 
    // MINUTES /////////////////
    lQuot = lRem / 1500;      // frames in non-drop-frame minute
    lRem = lRem % 1500;
    lMn = lQuot;
 
    // SECONDS //////////////
    lQuot = lRem / 25;        // frames in non-drop-frame second
    lRem = lRem % 25;
    lSc = lQuot;
 
    // FRAMES ///////////////
    lFr = lRem;
 
    // return results
    *plHrResult = lHr;
    *plMnResult = lMn;
    *plScResult = lSc;
    *plFrResult = lFr;
 
    }
  else
    {
    // drop-frame count mode is not supported for 25 fps
    }
  }
else if( TCBASERATEx ==  TCBASERATE_24FPS)
  {
  if( TCTYPEx ==  TCTYPE_FIELD1_NON_DROP_FRAME
      ||  TCTYPEx ==  TCTYPE_FIELD2_NON_DROP_FRAME)
    {
    // convert as 24 fps non-drop frame
 
    #ifdef USE_24HOUR_ROLLOVER
    if(lFrames >= 2073600)     // 24 hour rollover
      lFrames -= 2073600;
    #endif // #ifdef USE_24HOUR_ROLLOVER
 
    // HOURS /////////////////
    lQuot = lFrames / 86400;  // frames in non-drop-frame hour
    lRem = lFrames % 86400;
    lHr = lQuot;
 
    // MINUTES /////////////////
    lQuot = lRem / 1440;      // frames in non-drop-frame minute
    lRem = lRem % 1440;
    lMn = lQuot;
 
    // SECONDS //////////////
    lQuot = lRem / 24;        // frames in non-drop-frame second
    lRem = lRem % 24;
    lSc = lQuot;
 
    // FRAMES ///////////////
    lFr = lRem;
 
    // return results
    *plHrResult = lHr;
    *plMnResult = lMn;
    *plScResult = lSc;
    *plFrResult = lFr;
 
    }
  else
    {
    // drop-frame count mode is not supported for 24 fps
    }
  }
 
return iRet;
 
} //  _Frames_To_HMSF()


int  PW_Frames_To_TextTC(
                         int lFrames,
                         TCBASERATE  TCBASERATEx,
                         TCTYPE  TCTYPEx,
                         char* sTimecodeResult)
{
    int iRet = 0; // no error handling provided
     
     int lHr = 0;
     int lMn = 0;
     int lSc = 0;
     int lFr = 0;
     
      PW_Frames_To_HMSF(  lFrames,
                          TCBASERATEx,
                          TCTYPEx,
                          &lHr,
                          &lMn,
                          &lSc,
                          &lFr);
     
    // HMSF to ascii text /////////////
    // "00:00:00:00"
    sprintf(sTimecodeResult, "%02d:%02d:%02d:%02d",
    lHr,
    lMn,
    lSc,
    lFr
    );
     
    // Set the last separator to timecode type character
    if(  TCTYPEx ==   TCTYPE_FIELD1_NON_DROP_FRAME)
      sTimecodeResult[8] = '.';  // period
    else if(  TCTYPEx ==   TCTYPE_FIELD2_NON_DROP_FRAME)
      sTimecodeResult[8] = ':';  // colon
    else if(  TCTYPEx ==   TCTYPE_FIELD1_DROP_FRAME)
      sTimecodeResult[8] = ',';  // comma
    else if(  TCTYPEx ==   TCTYPE_FIELD2_DROP_FRAME)
      sTimecodeResult[8] = ';';  // semicolon
     
    return iRet;
}
